/*
 * Copyright (c) 2017, RISE SICS.
 * All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions
 * are met:
 * 1. Redistributions of source code must retain the above copyright
 *    notice, this list of conditions and the following disclaimer.
 * 2. Redistributions in binary form must reproduce the above copyright
 *    notice, this list of conditions and the following disclaimer in the
 *    documentation and/or other materials provided with the distribution.
 * 3. Neither the name of the Institute nor the names of its contributors
 *    may be used to endorse or promote products derived from this software
 *    without specific prior written permission.
 *
 * THIS SOFTWARE IS PROVIDED BY THE INSTITUTE AND CONTRIBUTORS ``AS IS'' AND
 * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
 * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE
 * ARE DISCLAIMED.  IN NO EVENT SHALL THE INSTITUTE OR CONTRIBUTORS BE LIABLE
 * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL
 * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS
 * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)
 * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT
 * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY
 * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF
 * SUCH DAMAGE.
 *
 * This file is part of the Contiki operating system.
 *
 */

/**
 * \file
 *         NullNet unicast example
 * \author
 *         Simon Duquennoy <simon.duquennoy@ri.se>
 *
 */

#include "contiki.h"
#include "net/netstack.h"
#include "net/nullnet/nullnet.h"
// add include tsch.h
#include "net/mac/tsch/tsch.h"
// #include "sys/node-id.h"

#include <string.h>
#include <stdio.h> /* For printf() */

/* Log configuration */
#include "sys/log.h"
#define LOG_MODULE "App"
#define LOG_LEVEL LOG_LEVEL_INFO

/* Configuration */
#define SEND_INTERVAL (1 * CLOCK_SECOND / 100)
// #define SEND_INTERVAL_512 (512 * CLOCK_SECOND / 100)
static linkaddr_t dest_addr = {{0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}};
// static linkaddr_t node_addr = {{0x02, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}};

// #if MAC_CONF_WITH_TSCH
// #include "net/mac/tsch/tsch.h"
static linkaddr_t coordinator_addr = {{0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}};
// #endif /* MAC_CONF_WITH_TSCH */

/* Put all cells on the same slotframe */
#define APP_SLOTFRAME_HANDLE 1
/* Put all unicast cells on the same timeslot (for demonstration purposes only) */
#define APP_UNICAST_TIMESLOT 1

/* ID<->MAC address mapping */
struct id_mac
{
  uint16_t id;
  linkaddr_t mac;
};

/* List of ID<->MAC mapping used for different deployments */
static const struct id_mac id_mac_list[] = {
    {1, {{0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}}, // 1
    {2, {{0x02, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}}, // 2
    {3, {{0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {4, {{0x04, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {5, {{0x05, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {6, {{0x06, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {7, {{0x07, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {8, {{0x08, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {9, {{0x09, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {10, {{0x0A, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {11, {{0x0B, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {12, {{0x0C, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {13, {{0x0D, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {14, {{0x0E, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {15, {{0x0F, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {16, {{0x10, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {17, {{0x11, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {18, {{0x12, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {19, {{0x13, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {20, {{0x14, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {21, {{0x15, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {22, {{0x16, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {23, {{0x17, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {24, {{0x18, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {25, {{0x19, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {26, {{0x1A, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {27, {{0x1B, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {28, {{0x1C, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {29, {{0x1D, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {30, {{0x1E, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {31, {{0x1F, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {32, {{0x20, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {33, {{0x21, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {34, {{0x22, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {35, {{0x23, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {36, {{0x24, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {37, {{0x25, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {38, {{0x26, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {39, {{0x27, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {40, {{0x28, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {41, {{0x29, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {42, {{0x2A, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {43, {{0x2B, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {44, {{0x2C, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {45, {{0x2D, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {46, {{0x2E, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {47, {{0x2F, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {48, {{0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {49, {{0x31, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {50, {{0x32, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {51, {{0x33, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {52, {{0x34, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {53, {{0x35, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {54, {{0x36, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {55, {{0x37, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {56, {{0x38, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {57, {{0x39, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {58, {{0x3A, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {59, {{0x3B, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {60, {{0x3C, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {61, {{0x3D, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {62, {{0x3E, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {63, {{0x3F, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {64, {{0x40, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {65, {{0x41, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {66, {{0x42, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {67, {{0x43, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {68, {{0x44, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {69, {{0x45, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {70, {{0x46, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {71, {{0x47, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {72, {{0x48, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {73, {{0x49, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {74, {{0x4A, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {75, {{0x4B, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {76, {{0x4C, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {77, {{0x4D, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {78, {{0x4E, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {79, {{0x4F, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {80, {{0x50, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {81, {{0x51, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {82, {{0x52, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {83, {{0x53, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {84, {{0x54, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {85, {{0x55, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {86, {{0x56, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {87, {{0x57, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {88, {{0x58, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {89, {{0x59, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {90, {{0x5A, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {91, {{0x5B, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {92, {{0x5C, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {93, {{0x5D, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {94, {{0x5E, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {95, {{0x5F, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {96, {{0x60, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {97, {{0x61, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {98, {{0x62, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {99, {{0x63, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {100, {{0x64, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {101, {{0x65, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}}, // 1
    {102, {{0x66, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}}, // 2
    {103, {{0x67, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {104, {{0x68, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {105, {{0x69, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {106, {{0x6A, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {107, {{0x6B, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {108, {{0x6C, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {109, {{0x6D, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {110, {{0x6E, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {111, {{0x6F, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {112, {{0x70, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {113, {{0x71, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {114, {{0x72, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {115, {{0x73, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {116, {{0x74, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {117, {{0x75, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {118, {{0x76, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {119, {{0x77, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {120, {{0x78, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {121, {{0x79, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {122, {{0x7A, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {123, {{0x7B, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {124, {{0x7C, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {125, {{0x7D, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {126, {{0x7E, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {127, {{0x7F, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {128, {{0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {129, {{0x81, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {130, {{0x82, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {131, {{0x83, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {132, {{0x84, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {133, {{0x85, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {134, {{0x86, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {135, {{0x87, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {136, {{0x88, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {137, {{0x89, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {138, {{0x8A, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {139, {{0x8B, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {140, {{0x8C, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {141, {{0x8D, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {142, {{0x8E, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {143, {{0x8F, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {144, {{0x90, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {145, {{0x91, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {146, {{0x92, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {147, {{0x93, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {148, {{0x94, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {149, {{0x95, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {150, {{0x96, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {151, {{0x97, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {152, {{0x98, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {153, {{0x99, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {154, {{0x9A, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {155, {{0x9B, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {156, {{0x9C, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {157, {{0x9D, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {158, {{0x9E, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {159, {{0x9F, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {160, {{0xA0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {161, {{0xA1, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {162, {{0xA2, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {163, {{0xA3, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {164, {{0xA4, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {165, {{0xA5, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {166, {{0xA6, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {167, {{0xA7, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {168, {{0xA8, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {169, {{0xA9, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {170, {{0xAA, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {171, {{0xAB, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {172, {{0xAC, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {173, {{0xAD, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {174, {{0xAE, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {175, {{0xAF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {176, {{0xB0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {177, {{0xB1, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {178, {{0xB2, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {179, {{0xB3, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {180, {{0xB4, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {181, {{0xB5, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {182, {{0xB6, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {183, {{0xB7, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {184, {{0xB8, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {185, {{0xB9, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {186, {{0xBA, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {187, {{0xBB, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {188, {{0xBC, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {189, {{0xBD, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {190, {{0xBE, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {191, {{0xBF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {192, {{0xC0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {193, {{0xC1, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {194, {{0xC2, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {195, {{0xC3, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {196, {{0xC4, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {197, {{0xC5, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {198, {{0xC6, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {199, {{0xC7, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    // {200, {{0xC8, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {0, {{0}}}};

static const struct id_mac id_mac_list_2hop[] = {
    {101, {{0x65, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}}, // 1
    {102, {{0x66, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}}, // 2
    {103, {{0x67, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {104, {{0x68, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {105, {{0x69, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {106, {{0x6A, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {107, {{0x6B, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {108, {{0x6C, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {109, {{0x6D, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {110, {{0x6E, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {111, {{0x6F, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {112, {{0x70, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {113, {{0x71, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {114, {{0x72, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {115, {{0x73, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {116, {{0x74, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {117, {{0x75, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {118, {{0x76, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {119, {{0x77, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {120, {{0x78, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {121, {{0x79, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {122, {{0x7A, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {123, {{0x7B, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {124, {{0x7C, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {125, {{0x7D, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {126, {{0x7E, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {127, {{0x7F, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {128, {{0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {129, {{0x81, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {130, {{0x82, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {131, {{0x83, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {132, {{0x84, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {133, {{0x85, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {134, {{0x86, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {135, {{0x87, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {136, {{0x88, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {137, {{0x89, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {138, {{0x8A, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {139, {{0x8B, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {140, {{0x8C, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {141, {{0x8D, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {142, {{0x8E, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {143, {{0x8F, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {144, {{0x90, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {145, {{0x91, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {146, {{0x92, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {147, {{0x93, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {148, {{0x94, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {149, {{0x95, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {150, {{0x96, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {151, {{0x97, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {152, {{0x98, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {153, {{0x99, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {154, {{0x9A, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {155, {{0x9B, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {156, {{0x9C, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {157, {{0x9D, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {158, {{0x9E, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {159, {{0x9F, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {160, {{0xA0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {161, {{0xA1, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {162, {{0xA2, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {163, {{0xA3, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {164, {{0xA4, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {165, {{0xA5, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {166, {{0xA6, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {167, {{0xA7, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {168, {{0xA8, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {169, {{0xA9, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {170, {{0xAA, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {171, {{0xAB, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {172, {{0xAC, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {173, {{0xAD, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {174, {{0xAE, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {175, {{0xAF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {176, {{0xB0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {177, {{0xB1, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {178, {{0xB2, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {179, {{0xB3, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {180, {{0xB4, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {181, {{0xB5, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {182, {{0xB6, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {183, {{0xB7, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {184, {{0xB8, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {185, {{0xB9, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {186, {{0xBA, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {187, {{0xBB, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {188, {{0xBC, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {189, {{0xBD, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {190, {{0xBE, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {191, {{0xBF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {192, {{0xC0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {193, {{0xC1, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {194, {{0xC2, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {195, {{0xC3, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {196, {{0xC4, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {197, {{0xC5, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {198, {{0xC6, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {199, {{0xC7, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    // {200, {{0xC8, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}}},
    {0, {{0}}}};

static void
install_node_schedule(uint16_t id_node)
{
  struct tsch_slotframe *sf_common = tsch_schedule_add_slotframe(APP_SLOTFRAME_HANDLE, APP_SLOTFRAME_SIZE);

  uint16_t slot_offset;
  uint16_t channel_offset;

  /* A "catch-all" cell at (0, 0) */
  slot_offset = 0;
  channel_offset = 0;
  tsch_schedule_add_link(sf_common,
                         LINK_OPTION_RX | LINK_OPTION_TX | LINK_OPTION_SHARED,
                         LINK_TYPE_ADVERTISING, &tsch_broadcast_address,
                         slot_offset, channel_offset, 1);

  if (id_node > 100)
  {
    // if id_node = 101, temp = 1; curr[1]->id = hop_id = 2
    const struct id_mac *curr = id_mac_list;
    uint16_t hop_id = id_node - 99;

    while (curr->id != 0)
    {
      if (curr->id == hop_id)
      {
        struct tsch_slotframe *sf_tx = tsch_schedule_add_slotframe(2, 512);
        linkaddr_t hop_addr = curr->mac;
        slot_offset = hop_id + 200;
        channel_offset = 1;
        tsch_schedule_add_link(sf_tx, LINK_OPTION_RX | LINK_OPTION_TX, LINK_TYPE_NORMAL, &hop_addr, slot_offset, channel_offset, 0);
        break;
      }

      curr++;
    }
  }
  else
  {
    struct tsch_slotframe *sf_tx = tsch_schedule_add_slotframe(2, 512);
    // first transmission
    slot_offset = id_node;
    channel_offset = 0;
    tsch_schedule_add_link(sf_tx, LINK_OPTION_RX | LINK_OPTION_TX, LINK_TYPE_NORMAL, &dest_addr, slot_offset, channel_offset, 0);

    const struct id_mac *curr = id_mac_list_2hop;
    uint16_t hop_id = id_node + 99;

    while (curr->id != 0)
    {
      if (curr->id == hop_id)
      {
        struct tsch_slotframe *sf_hop = tsch_schedule_add_slotframe(3, 512);
        linkaddr_t hop_addr = curr->mac;
        slot_offset = id_node + 200;
        channel_offset = 1;
        tsch_schedule_add_link(sf_hop, LINK_OPTION_RX | LINK_OPTION_TX, LINK_TYPE_NORMAL, &hop_addr, slot_offset, channel_offset, 0);

        // second tx
        slot_offset = hop_id;
        channel_offset = 0;
        tsch_schedule_add_link(sf_hop, LINK_OPTION_RX | LINK_OPTION_TX, LINK_TYPE_NORMAL, &dest_addr, slot_offset, channel_offset, 0);
        break;
      }

      curr++;
    }

   
  }

  tsch_schedule_print();
  LOG_INFO("NODE SCHEDULE INSTALLED!!\n");
}

static void
initialize_coord_schedule(void)
{

  struct tsch_slotframe *sf_common = tsch_schedule_add_slotframe(APP_SLOTFRAME_HANDLE, APP_SLOTFRAME_SIZE);
  struct tsch_slotframe *sf_tx = tsch_schedule_add_slotframe(2, 512);
  struct tsch_slotframe *sf_hop = tsch_schedule_add_slotframe(3, 512);
  // struct tsch_slotframe *sf_tx_2 = tsch_schedule_add_slotframe(3, 256);
  // int i;

  uint16_t slot_offset;
  uint16_t channel_offset;

  /* A "catch-all" cell at (0, 0) */
  slot_offset = 0;
  channel_offset = 0;
  tsch_schedule_add_link(sf_common,
                         LINK_OPTION_RX | LINK_OPTION_TX | LINK_OPTION_SHARED,
                         LINK_TYPE_ADVERTISING, &tsch_broadcast_address,
                         slot_offset, channel_offset, 1);

  const struct id_mac *curr = id_mac_list;
  while (curr->id < 101)
  {
    uint16_t id = curr->id;
    linkaddr_t node_addr = curr->mac;
    slot_offset = id;

    tsch_schedule_add_link(sf_tx, LINK_OPTION_RX | LINK_OPTION_TX, LINK_TYPE_NORMAL, &node_addr, slot_offset, channel_offset, 0);

    tsch_schedule_add_link(sf_hop, LINK_OPTION_RX | LINK_OPTION_TX, LINK_TYPE_NORMAL, &node_addr, slot_offset + 99, channel_offset, 0);

    curr++;
    // LOG_INFO("ID %u \n", curr->id);
  }
  tsch_schedule_print();
  LOG_INFO("COORDINATOR SCHEDULE INSTALLED!!\n");
}

/* Returns the node's node-id */
uint16_t
get_node_id(linkaddr_t *addr)
{
  const struct id_mac *curr = id_mac_list;
  while (curr->id != 0)
  {
    /* Assume network-wide unique 16-bit MAC addresses */
    if (curr->mac.u8[0] == addr->u8[0] && curr->mac.u8[1] == addr->u8[1])
    {
      return curr->id;
    }
    curr++;
  }
  return 0;
}

/* Returns the node's linkaddr */
linkaddr_t
get_node_addr(uint16_t sender_id)
{
  const struct id_mac *curr = id_mac_list;
  uint16_t hop_id = sender_id - 99;

  while (curr->id != 0)
  {
    if (curr->id == hop_id)
    {
      linkaddr_t hop_addr = curr->mac;
      return hop_addr;
    }

    curr++;
  }

  linkaddr_t def_addr = {{0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}};
  return def_addr;
}

/*---------------------------------------------------------------------------*/
PROCESS(nullnet_example_process, "NullNet unicast example");
AUTOSTART_PROCESSES(&nullnet_example_process);

/*---------------------------------------------------------------------------*/
void input_callback(const void *data, uint16_t len,
                    const linkaddr_t *src, const linkaddr_t *dest)
{
  if (len == sizeof(unsigned))
  {
    unsigned count;
    uint8_t ch = tsch_current_channel;
    memcpy(&count, data, sizeof(count));
    LOG_INFO("Received %u at ch %u from ", count, ch);
    LOG_INFO_LLADDR(src);
    // LOG_INFO("", ch);
    LOG_INFO_("\n");
  }
}
/*---------------------------------------------------------------------------*/
PROCESS_THREAD(nullnet_example_process, ev, data)
{
  static struct etimer periodic_timer; // periodic_timer_512;
  static unsigned count = 0;
  static uint16_t node_id;
  int is_coordinator;
  // static linkaddr_t hop_addr;

  PROCESS_BEGIN();
  is_coordinator = linkaddr_cmp(&coordinator_addr, &linkaddr_node_addr);

  tsch_set_coordinator(is_coordinator);

  if (is_coordinator)
  {
    initialize_coord_schedule();
  }
  else
  {
    node_id = get_node_id(&linkaddr_node_addr);
    count = node_id;
    
    install_node_schedule(node_id);
  }

  /* Initialize NullNet */
  nullnet_buf = (uint8_t *)&count;
  nullnet_len = sizeof(count);
  nullnet_set_input_callback(input_callback);

  if (!linkaddr_cmp(&dest_addr, &linkaddr_node_addr))
  {
    etimer_set(&periodic_timer, SEND_INTERVAL);
    
    while (1)
    {

      PROCESS_WAIT_EVENT_UNTIL(etimer_expired(&periodic_timer));

      if (node_id > 100)
      {
        linkaddr_t hop_addr = get_node_addr(node_id);
        LOG_INFO("Node id %u ", node_id);
        LOG_INFO_("\n");
        LOG_INFO("Sending %u to ", count);
        LOG_INFO_LLADDR(&hop_addr);

        LOG_INFO_("\n");

        NETSTACK_NETWORK.output(&hop_addr);
        etimer_reset(&periodic_timer);
      }
      else
      {
        LOG_INFO("Sending %u to ", count);
        LOG_INFO_LLADDR(&dest_addr);

        LOG_INFO_("\n");

        NETSTACK_NETWORK.output(&dest_addr);
        etimer_reset(&periodic_timer);
      }
    }
  }

  PROCESS_END();
}
/*---------------------------------------------------------------------------*/
